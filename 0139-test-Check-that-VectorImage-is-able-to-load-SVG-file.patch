From 6caacc07a3270b862652e8aa5f4f0cb73a801633 Mon Sep 17 00:00:00 2001
From: Eskil Abrahamsen Blomfeldt <eskil.abrahamsen-blomfeldt@qt.io>
Date: Fri, 3 Oct 2025 14:26:06 +0200
Subject: [PATCH 139/239] test: Check that VectorImage is able to load SVG
 files

This test collects all SVGs from our baseline tests, loads them
with a VectorImage component and checks that we get an item with
dimensions different from 0x0. If the parsing for some reason fails
then the dimensions will be 0x0.

Task-number: QTBUG-140812
Change-Id: I889a50ef9d58edf2d126555e645477f52b571620
Reviewed-by: Eirik Aavitsland <eirik.aavitsland@qt.io>
(cherry picked from commit b8a885973c7ed48bb6657fb6bbd47be993b6b1aa)
---
 tests/auto/CMakeLists.txt                     |  3 +
 tests/auto/quickvectorimage/CMakeLists.txt    | 11 +++
 .../qquickvectorimage/CMakeLists.txt          | 48 ++++++++++
 .../qquickvectorimage/data/svg/broken.svg     | 20 +++++
 .../qquickvectorimage/data/vectorimage.qml    | 12 +++
 .../tst_qquickvectorimage.cpp                 | 88 +++++++++++++++++++
 6 files changed, 182 insertions(+)
 create mode 100644 tests/auto/quickvectorimage/CMakeLists.txt
 create mode 100644 tests/auto/quickvectorimage/qquickvectorimage/CMakeLists.txt
 create mode 100644 tests/auto/quickvectorimage/qquickvectorimage/data/svg/broken.svg
 create mode 100644 tests/auto/quickvectorimage/qquickvectorimage/data/vectorimage.qml
 create mode 100644 tests/auto/quickvectorimage/qquickvectorimage/tst_qquickvectorimage.cpp

diff --git a/tests/auto/CMakeLists.txt b/tests/auto/CMakeLists.txt
index 86af69845a..8b8bf8ff32 100644
--- a/tests/auto/CMakeLists.txt
+++ b/tests/auto/CMakeLists.txt
@@ -52,3 +52,6 @@ endif()
 if (ANDROID)
     add_subdirectory(qtquickview)
 endif()
+if (TARGET Qt::Quick AND TARGET Qt::Svg)
+    add_subdirectory(quickvectorimage)
+endif()
diff --git a/tests/auto/quickvectorimage/CMakeLists.txt b/tests/auto/quickvectorimage/CMakeLists.txt
new file mode 100644
index 0000000000..24aaaf6cfc
--- /dev/null
+++ b/tests/auto/quickvectorimage/CMakeLists.txt
@@ -0,0 +1,11 @@
+# Copyright (C) 2025 The Qt Company Ltd.
+# SPDX-License-Identifier: BSD-3-Clause
+
+# Limit set of tests to run for static Qt builds.
+if(QT_BUILD_MINIMAL_STATIC_TESTS)
+    return()
+endif()
+
+if(QT_FEATURE_private_tests)
+    add_subdirectory(qquickvectorimage)
+endif()
diff --git a/tests/auto/quickvectorimage/qquickvectorimage/CMakeLists.txt b/tests/auto/quickvectorimage/qquickvectorimage/CMakeLists.txt
new file mode 100644
index 0000000000..564640041e
--- /dev/null
+++ b/tests/auto/quickvectorimage/qquickvectorimage/CMakeLists.txt
@@ -0,0 +1,48 @@
+# Copyright (C) 2025 The Qt Company Ltd.
+# SPDX-License-Identifier: BSD-3-Clause
+
+if(NOT QT_BUILD_STANDALONE_TESTS AND NOT QT_BUILDING_QT)
+    cmake_minimum_required(VERSION 3.16)
+    project(tst_qquickvectorimage LANGUAGES CXX)
+    find_package(Qt6BuildInternals REQUIRED COMPONENTS STANDALONE_TEST)
+endif()
+
+# Collect test data
+file(GLOB_RECURSE test_data_glob
+    RELATIVE ${CMAKE_CURRENT_SOURCE_DIR}
+    data/*)
+list(APPEND test_data ${test_data_glob})
+
+qt_internal_add_test(tst_qquickvectorimage
+    SOURCES
+        tst_qquickvectorimage.cpp
+    LIBRARIES
+        Qt::CorePrivate
+        Qt::Gui
+        Qt::GuiPrivate
+        Qt::Qml
+        Qt::QmlPrivate
+        Qt::QuickPrivate
+        Qt::QuickTestUtilsPrivate
+    TESTDATA
+        ${test_data}
+    DEFINES
+        QT_QMLTEST_DATADIR="${CMAKE_CURRENT_SOURCE_DIR}/data"
+)
+
+file(GLOB_RECURSE test_data_glob_svg
+    RELATIVE ${CMAKE_CURRENT_SOURCE_DIR}
+    ${CMAKE_CURRENT_SOURCE_DIR}/../../../baseline/scenegraph/data/shared/svg/*)
+list(APPEND svg_data ${test_data_glob_svg})
+
+qt_add_resources(tst_qquickvectorimage svgs
+    PREFIX /svgs
+    BASE ${CMAKE_CURRENT_SOURCE_DIR}/../../../baseline/scenegraph/data/shared/svg/
+    FILES
+        ${svg_data}
+)
+
+qt_internal_extend_target(tst_qquickvectorimage CONDITION ANDROID OR IOS
+    DEFINES
+    QT_QMLTEST_DATADIR=":/data"
+)
diff --git a/tests/auto/quickvectorimage/qquickvectorimage/data/svg/broken.svg b/tests/auto/quickvectorimage/qquickvectorimage/data/svg/broken.svg
new file mode 100644
index 0000000000..cec67cc24d
--- /dev/null
+++ b/tests/auto/quickvectorimage/qquickvectorimage/data/svg/broken.svg
@@ -0,0 +1,20 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no"?>
+<svg
+   version="1.1"
+   x="0px"
+   y="0px"
+   viewBox="0 0 200 200"
+   xml:space="preserve">
+   <foo>
+   <image
+     width="100"
+     height="100"
+     xlink:href="data:image/jpg;base64,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"
+     transform="matrix(1 0 0 1 50 50)" />
+   <circle
+     fill="red"
+     cx="100"
+     cy="100"
+     r="20"
+     id="circle356" />
+</svg>
diff --git a/tests/auto/quickvectorimage/qquickvectorimage/data/vectorimage.qml b/tests/auto/quickvectorimage/qquickvectorimage/data/vectorimage.qml
new file mode 100644
index 0000000000..80f9b50e9d
--- /dev/null
+++ b/tests/auto/quickvectorimage/qquickvectorimage/data/vectorimage.qml
@@ -0,0 +1,12 @@
+// Copyright (C) 2025 The Qt Company Ltd.
+// SPDX-License-Identifier: LicenseRef-Qt-Commercial OR GPL-3.0-only
+
+import QtQuick
+import QtQuick.Shapes
+import QtQuick.VectorImage
+
+VectorImage {
+    width: 440
+    height: 220
+    source: fileName
+}
diff --git a/tests/auto/quickvectorimage/qquickvectorimage/tst_qquickvectorimage.cpp b/tests/auto/quickvectorimage/qquickvectorimage/tst_qquickvectorimage.cpp
new file mode 100644
index 0000000000..300bda51bc
--- /dev/null
+++ b/tests/auto/quickvectorimage/qquickvectorimage/tst_qquickvectorimage.cpp
@@ -0,0 +1,88 @@
+// Copyright (C) 2025 The Qt Company Ltd.
+// SPDX-License-Identifier: LicenseRef-Qt-Commercial OR GPL-3.0-only
+
+#include <QtTest/QTest>
+#include <QtTest/QSignalSpy>
+#include <QtCore/qfileinfo.h>
+#include <QtCore/qdir.h>
+#include <QtQml/qqmlcontext.h>
+#include <QtQml/qqmlengine.h>
+#include <QtQml/qqmlcomponent.h>
+#include <QtQuick/qquickitem.h>
+
+#include <QtQuickTestUtils/private/qmlutils_p.h>
+#include <QtQuickTestUtils/private/viewtestutils_p.h>
+#include <QtQuickTestUtils/private/visualtestutils_p.h>
+
+class tst_QQuickVectorImage : public QQmlDataTest
+{
+    Q_OBJECT
+public:
+    tst_QQuickVectorImage();
+
+private slots:
+    void parseFiles_data();
+    void parseFiles();
+    void parseBrokenFile();
+};
+
+tst_QQuickVectorImage::tst_QQuickVectorImage()
+    : QQmlDataTest(QT_QMLTEST_DATADIR)
+{
+}
+
+void tst_QQuickVectorImage::parseFiles_data()
+{
+    QTest::addColumn<QString>("fileName");
+
+    QDir dir(QStringLiteral(":/svgs"));
+    const QFileInfoList infos = dir.entryInfoList({ QStringLiteral("*.svg") });
+
+    QVERIFY(!infos.isEmpty());
+    for (const QFileInfo &info : infos) {
+        QString fileName = info.fileName();
+        QByteArray rowName = fileName.toUtf8();
+
+        QTest::newRow(rowName) << fileName;
+    }
+}
+
+void tst_QQuickVectorImage::parseFiles()
+{
+    QFETCH(QString, fileName);
+
+    QQmlEngine engine;
+    engine.rootContext()->setContextProperty(QStringLiteral("fileName"), QStringLiteral("qrc:/svgs/%1").arg(fileName));
+
+    QQmlComponent c(&engine, testFileUrl("vectorimage.qml"));
+    QQuickItem *item = qobject_cast<QQuickItem *>(c.create());
+    auto cleanup = qScopeGuard([&item] {
+        delete item;
+        item = nullptr;
+    });
+
+    QVERIFY(item != nullptr);
+    QVERIFY(!item->childItems().isEmpty());
+    QVERIFY(!item->childItems().first()->size().isNull());
+}
+
+void tst_QQuickVectorImage::parseBrokenFile()
+{
+    QQmlEngine engine;
+    engine.rootContext()->setContextProperty(QStringLiteral("fileName"), testFileUrl("svg/broken.svg"));
+
+    QQmlComponent c(&engine, testFileUrl("vectorimage.qml"));
+    QQuickItem *item = qobject_cast<QQuickItem *>(c.create());
+    auto cleanup = qScopeGuard([&item] {
+        delete item;
+        item = nullptr;
+    });
+
+    QVERIFY(item != nullptr);
+    QVERIFY(!item->childItems().isEmpty());
+    QVERIFY(item->childItems().first()->size().isNull());
+}
+
+QTEST_MAIN(tst_QQuickVectorImage)
+
+#include "tst_qquickvectorimage.moc"
-- 
2.51.2

