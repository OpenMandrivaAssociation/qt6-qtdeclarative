From 9e4a4986141269b740f2f94c57bb4327cf105e11 Mon Sep 17 00:00:00 2001
From: Sami Shalayel <sami.shalayel@qt.io>
Date: Thu, 11 Sep 2025 13:28:48 +0200
Subject: [PATCH 113/239] qmlformat: format return type annotations
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Adapt the parser to not ignore return type annotations in function
declarations, and visit the return type annotations in the
ScriptFormatter visitor.

Task-number: QTBUG-137944
Change-Id: Ib54aa17b056a87215baa83535038b867a3b7e195
Reviewed-by: Olivier De Canni√®re <olivier.decanniere@qt.io>
(cherry picked from commit bc1d2c3726440026bab9f8427faf19bb5e48ff31)
---
 src/qml/parser/qqmljs.g                       |  5 ++--
 src/qmldom/qqmldomreformatter.cpp             |  1 +
 .../auto/qmldom/reformatter/tst_reformatter.h | 23 ++++++++++++++-----
 3 files changed, 20 insertions(+), 9 deletions(-)

diff --git a/src/qml/parser/qqmljs.g b/src/qml/parser/qqmljs.g
index 96d9dc59c9..8837b174c5 100644
--- a/src/qml/parser/qqmljs.g
+++ b/src/qml/parser/qqmljs.g
@@ -3976,8 +3976,7 @@ FunctionDeclaration: Function BindingIdentifier T_LPAREN FormalParameters T_RPAR
     case $rule_number: {
         if (!ensureNoFunctionTypeAnnotations(sym(6).TypeAnnotation, sym(4).FormalParameterList))
             return false;
-        AST::FunctionDeclaration *node = new (pool) AST::FunctionDeclaration(stringRef(2), sym(4).FormalParameterList, sym(8).StatementList,
-                                                                             /*type annotation*/nullptr);
+        AST::FunctionDeclaration *node = new (pool) AST::FunctionDeclaration(stringRef(2), sym(4).FormalParameterList, sym(8).StatementList, sym(6).TypeAnnotation);
         node->functionToken = loc(1);
         node->identifierToken = loc(2);
         node->lparenToken = loc(3);
@@ -4010,7 +4009,7 @@ FunctionDeclaration_Default: Function T_LPAREN FormalParameters T_RPAREN TypeAnn
         if (!ensureNoFunctionTypeAnnotations(sym(5).TypeAnnotation, sym(3).FormalParameterList))
             return false;
         AST::FunctionDeclaration *node = new (pool) AST::FunctionDeclaration(QStringView(), sym(3).FormalParameterList, sym(7).StatementList,
-                                                                             /*type annotation*/nullptr);
+                                                                             sym(5).TypeAnnotation);
         node->functionToken = loc(1);
         node->lparenToken = loc(2);
         node->rparenToken = loc(4);
diff --git a/src/qmldom/qqmldomreformatter.cpp b/src/qmldom/qqmldomreformatter.cpp
index 9b8290c1bb..fb4323d29b 100644
--- a/src/qmldom/qqmldomreformatter.cpp
+++ b/src/qmldom/qqmldomreformatter.cpp
@@ -861,6 +861,7 @@ bool ScriptFormatter::visit(FunctionExpression *ast)
     accept(ast->formals);
     lw.decreaseIndent(1, baseIndent);
     outWithComments(ast->rparenToken, ast, removeParentheses ? OnlyComments : NoSpace);
+    accept(ast->typeAnnotation);
     lw.lineWriter.ensureSpace();
     if (ast->isArrowFunction) {
         out("=>");
diff --git a/tests/auto/qmldom/reformatter/tst_reformatter.h b/tests/auto/qmldom/reformatter/tst_reformatter.h
index b3e4eac677..e426f37bf7 100644
--- a/tests/auto/qmldom/reformatter/tst_reformatter.h
+++ b/tests/auto/qmldom/reformatter/tst_reformatter.h
@@ -448,17 +448,19 @@ private slots:
         QTest::addColumn<QString>("declarationToBeFormatted");
         QTest::addColumn<QString>("expectedFormattedDeclaration");
 
-        QTest::newRow("Function") << u"function a(a:date,b:int){}"_s
-                                  << u"function a(a: date, b: int) {}"_s;
+        QTest::newRow("Function") << u"function a(a:date,b:int):real{}"_s
+                                  << u"function a(a: date, b: int): real {}"_s;
         // note: we need to wrap the lambda in `()`, otherwise its invalid JS
-        QTest::newRow("AnonymousFunction")
-                << u"(function (a:date,b:int){})"_s << u"(function (a: date, b: int) {})"_s;
+        QTest::newRow("AnonymousFunction") << u"(function (a:date,b:int):real{})"_s
+                                           << u"(function (a: date, b: int): real {})"_s;
+
+        // note: generator can't have return type annotations
         QTest::newRow("Generator_lhs_star")
                 << u"function* g(a:date,b:int){}"_s << u"function* g(a: date, b: int) {}"_s;
         QTest::newRow("Generator_rhs_star")
                 << u"function *g(a:int,b:date){}"_s << u"function* g(a: int, b: date) {}"_s;
-        QTest::newRow("list") << u"function a(a:list<date>,b:list<int>){}"_s
-                              << u"function a(a: list<date>, b: list<int>) {}"_s;
+        QTest::newRow("list") << u"function a(a:list<date>,b:list<int>):list<real>{}"_s
+                              << u"function a(a: list<date>, b: list<int>): list<real> {}"_s;
 
         QTest::newRow("comments")
                 << u"function a(a/*1*/:/*2*/list/*3*/</*4*/date/*5*/>/*6*/,/*7*/b/*8*/:/*9*/int/*10*/){}"_s
@@ -467,6 +469,15 @@ private slots:
         QTest::newRow("comments2")
                 << u"function a(a: Q/*10*/./*11*/W/*12*/./*13*/E/*14*/./*15*/R/*16*/){}"_s
                 << u"function a(a: Q/*10*/./*11*/W/*12*/./*13*/E/*14*/./*15*/R/*16*/) {}"_s;
+
+        QTest::newRow("commentsOnReturnType") << u"function a()/*1*/:/*2*/real/*3*/{}"_s
+                                              << u"function a()/*1*/: /*2*/real/*3*/ {}"_s;
+        QTest::newRow("commentsOnReturnType2")
+                << u"function a():Q/*10*/./*11*/W/*12*/./*13*/E/*14*/./*15*/R/*16*/{}"_s
+                << u"function a(): Q/*10*/./*11*/W/*12*/./*13*/E/*14*/./*15*/R/*16*/ {}"_s;
+        QTest::newRow("commentsOnListReturnType")
+                << u"function a():/*2*/list/*3*/</*4*/Q/*10*/./*11*/W/*12*/./*13*/E/*14*/./*15*/R/*16*/>/*17*/{}"_s
+                << u"function a(): /*2*/list/*3*/</*4*/Q/*10*/./*11*/W/*12*/./*13*/E/*14*/./*15*/R/*16*/>/*17*/ {}"_s;
     }
 
     void typeAnnotations()
-- 
2.51.2

