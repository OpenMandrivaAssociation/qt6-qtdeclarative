From e467e5c6ad39758f9bb7c5548619d3f028c72cb3 Mon Sep 17 00:00:00 2001
From: Ulf Hermann <ulf.hermann@qt.io>
Date: Mon, 22 Sep 2025 08:57:53 +0200
Subject: [PATCH 068/239] QmlCompiler: Don't adjust the same conversion
 multiple times
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

The same conversion can re-surface in multiple places in the byte code
by virtue of being stored and loaded unchanged. If we've already
adjusted it, we don't need to do it again.

Fixes: QTBUG-140415
Change-Id: Ic1e7e90af49f0ee9440a9c37abd4ab8ee0fdbe3e
Reviewed-by: Olivier De Canni√®re <olivier.decanniere@qt.io>
Reviewed-by: Sami Shalayel <sami.shalayel@qt.io>
(cherry picked from commit 044d3d2cdb7ba825069b3d1302b96723cb75d6ca)
Reviewed-by: Qt Cherry-pick Bot <cherrypick_bot@qt-project.org>
---
 src/qmlcompiler/qqmljsoptimizations.cpp       |  2 +-
 .../qml/qmlcppcodegen/data/CMakeLists.txt     |  1 +
 .../qml/qmlcppcodegen/data/multiAdjust.qml    | 25 ++++++++++
 .../qml/qmlcppcodegen/tst_qmlcppcodegen.cpp   | 49 +++++++++++++++++++
 4 files changed, 76 insertions(+), 1 deletion(-)
 create mode 100644 tests/auto/qml/qmlcppcodegen/data/multiAdjust.qml

diff --git a/src/qmlcompiler/qqmljsoptimizations.cpp b/src/qmlcompiler/qqmljsoptimizations.cpp
index 0383ad99b5..287f703f7e 100644
--- a/src/qmlcompiler/qqmljsoptimizations.cpp
+++ b/src/qmlcompiler/qqmljsoptimizations.cpp
@@ -480,7 +480,7 @@ void QQmlJSOptimizations::adjustTypes()
 
             QQmlJSScope::ConstPtr newResult;
             const auto content = conversion->second.content;
-            if (content.isConversion()) {
+            if (content.isConversion() && !content.original().isValid()) {
                 const auto conversionOrigins = content.conversionOrigins();
                 for (const auto &origin : conversionOrigins)
                     newResult = m_typeResolver->merge(newResult, origin.containedType());
diff --git a/tests/auto/qml/qmlcppcodegen/data/CMakeLists.txt b/tests/auto/qml/qmlcppcodegen/data/CMakeLists.txt
index d0a511bb00..27bd62a67e 100644
--- a/tests/auto/qml/qmlcppcodegen/data/CMakeLists.txt
+++ b/tests/auto/qml/qmlcppcodegen/data/CMakeLists.txt
@@ -241,6 +241,7 @@ set(qml_files
     methods.qml
     modulePrefix.qml
     moveRegVoid.qml
+    multiAdjust.qml
     multiRedirect.qml
     multiforeign.qml
     multipleCtors.qml
diff --git a/tests/auto/qml/qmlcppcodegen/data/multiAdjust.qml b/tests/auto/qml/qmlcppcodegen/data/multiAdjust.qml
new file mode 100644
index 0000000000..ae70733fc9
--- /dev/null
+++ b/tests/auto/qml/qmlcppcodegen/data/multiAdjust.qml
@@ -0,0 +1,25 @@
+pragma Strict
+import QtQml
+
+QtObject {
+    id: mainRow
+
+    property int calledFoo: 0
+    property int calledBar: 0
+
+    function foo(column: int) : void { ++calledFoo }
+    function bar(column: int) : void { ++calledBar }
+
+    property int a: 0
+    property int b: 0
+
+    signal event(key: int)
+
+    onEvent: key => {
+        let forwardArrowKey = (key === Qt.Key_Right && !mainRow.objectName.length)
+        if (2 > a)
+            mainRow.foo(mainRow.b)
+        if (forwardArrowKey)
+            mainRow.bar(mainRow.b)
+    }
+}
diff --git a/tests/auto/qml/qmlcppcodegen/tst_qmlcppcodegen.cpp b/tests/auto/qml/qmlcppcodegen/tst_qmlcppcodegen.cpp
index 10047ec11f..fe5ee65a22 100644
--- a/tests/auto/qml/qmlcppcodegen/tst_qmlcppcodegen.cpp
+++ b/tests/auto/qml/qmlcppcodegen/tst_qmlcppcodegen.cpp
@@ -198,6 +198,7 @@ private slots:
     void methodOnListLookup();
     void methods();
     void modulePrefix();
+    void multiAdjust();
     void multiDirectory_data();
     void multiDirectory();
     void multiForeign();
@@ -4041,6 +4042,54 @@ void tst_QmlCppCodegen::modulePrefix()
     QCOMPARE(rootObject->property("baz").toString(), QStringLiteral("ItIsTheSingleton"));
 }
 
+void tst_QmlCppCodegen::multiAdjust()
+{
+    QQmlEngine engine;
+    QQmlComponent component(&engine, QUrl(u"qrc:/qt/qml/TestTypes/multiAdjust.qml"_s));
+    QVERIFY2(component.isReady(), qPrintable(component.errorString()));
+
+    QScopedPointer<QObject> rootObject(component.create());
+    QVERIFY(rootObject);
+
+    QCOMPARE(rootObject->property("calledFoo"), 0);
+    QCOMPARE(rootObject->property("calledBar"), 0);
+
+    QMetaObject::invokeMethod(rootObject.data(), "event", Q_ARG(int, Qt::Key_Left));
+    QCOMPARE(rootObject->property("calledFoo"), 1);
+    QCOMPARE(rootObject->property("calledBar"), 0);
+
+    QMetaObject::invokeMethod(rootObject.data(), "event", Q_ARG(int, Qt::Key_Right));
+    QCOMPARE(rootObject->property("calledFoo"), 2);
+    QCOMPARE(rootObject->property("calledBar"), 1);
+
+    rootObject->setProperty("a", 3);
+    QMetaObject::invokeMethod(rootObject.data(), "event", Q_ARG(int, Qt::Key_Left));
+    QCOMPARE(rootObject->property("calledFoo"), 2);
+    QCOMPARE(rootObject->property("calledBar"), 1);
+
+    QMetaObject::invokeMethod(rootObject.data(), "event", Q_ARG(int, Qt::Key_Right));
+    QCOMPARE(rootObject->property("calledFoo"), 2);
+    QCOMPARE(rootObject->property("calledBar"), 2);
+
+    rootObject->setObjectName("a");
+    QMetaObject::invokeMethod(rootObject.data(), "event", Q_ARG(int, Qt::Key_Left));
+    QCOMPARE(rootObject->property("calledFoo"), 2);
+    QCOMPARE(rootObject->property("calledBar"), 2);
+
+    QMetaObject::invokeMethod(rootObject.data(), "event", Q_ARG(int, Qt::Key_Right));
+    QCOMPARE(rootObject->property("calledFoo"), 2);
+    QCOMPARE(rootObject->property("calledBar"), 2);
+
+    rootObject->setProperty("a", 1);
+    QMetaObject::invokeMethod(rootObject.data(), "event", Q_ARG(int, Qt::Key_Left));
+    QCOMPARE(rootObject->property("calledFoo"), 3);
+    QCOMPARE(rootObject->property("calledBar"), 2);
+
+    QMetaObject::invokeMethod(rootObject.data(), "event", Q_ARG(int, Qt::Key_Right));
+    QCOMPARE(rootObject->property("calledFoo"), 4);
+    QCOMPARE(rootObject->property("calledBar"), 2);
+}
+
 void tst_QmlCppCodegen::multiDirectory_data()
 {
     QTest::addColumn<QUrl>("url");
-- 
2.51.2

