From e018f63d52a0c7d95384b90fe844ae0600fd2f02 Mon Sep 17 00:00:00 2001
From: Semih Yavuz <semih.yavuz@qt.io>
Date: Wed, 1 Oct 2025 13:32:09 +0200
Subject: [PATCH 177/239] qmlhighlighting: refactor for reusability
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Make the highlighted token class protocol agnostic by removing protocol
specific fields, and store  custom highlighting types and modifiers
instead. Move the logic that converts token types to protocol specific
integers to encodeSemanticTokens.
This simplifies HighlightingVisitor by removing protocol mapping
dependency and makes the tests protocol agnostic too. (before we weren't
testing QtC highlights).

Pick-to: 6.8
Task-number: QTBUG-140645
Change-Id: Ia0e84b50941f84855c4a1525f97a0d21da0f3947
Reviewed-by: Olivier De Canni√®re <olivier.decanniere@qt.io>
(cherry picked from commit 6f8b21866df9b684b952d0bc2c798ec9eab28b96)
Reviewed-by: Qt Cherry-pick Bot <cherrypick_bot@qt-project.org>
---
 src/qmlls/qqmlsemantictokens.cpp              |  69 +--
 src/qmlls/qqmlsemantictokens_p.h              |  40 +-
 .../qmlls/utils/tst_qmlls_highlighting.cpp    | 405 +++++++++---------
 3 files changed, 265 insertions(+), 249 deletions(-)

diff --git a/src/qmlls/qqmlsemantictokens.cpp b/src/qmlls/qqmlsemantictokens.cpp
index e15ec2e271..6356a16af6 100644
--- a/src/qmlls/qqmlsemantictokens.cpp
+++ b/src/qmlls/qqmlsemantictokens.cpp
@@ -225,12 +225,16 @@ static FieldFilter highlightingFilter()
     return FieldFilter{ fieldFilterAdd, fieldFilterRemove };
 }
 
+HighlightToken::HighlightToken(const QQmlJS::SourceLocation &loc,
+                               QmlHighlightKind kind,
+                               QmlHighlightModifiers modifiers)
+    : loc(loc), kind(kind), modifiers(modifiers)
+{
+}
+
 HighlightingVisitor::HighlightingVisitor(const QQmlJS::Dom::DomItem &item,
-                                         const std::optional<HighlightsRange> &range,
-                                         HighlightingMode mode)
-    : m_range(range), m_mapToProtocol(mode == HighlightingMode::Default
-                                                       ? mapToProtocolDefault
-                                                       : mapToProtocolForQtCreator)
+                                         const std::optional<HighlightsRange> &range)
+    : m_range(range)
 {
     item.visitTree(Path(),
                    [this](Path path, const DomItem &item, bool b) { return this->visitor(path, item, b); },
@@ -851,6 +855,12 @@ void HighlightingVisitor::highlightScriptExpressions(const DomItem &item)
     }
 }
 
+void HighlightingVisitor::addHighlight(const QQmlJS::SourceLocation &loc, QmlHighlightKind highlightKind,
+                              QmlHighlightModifiers modifierKind)
+{
+    return Utils::addHighlight(m_highlights, loc, highlightKind, modifierKind);
+}
+
 /*!
 \internal
 \brief Returns multiple source locations for a given raw comment
@@ -909,7 +919,7 @@ Utils::sourceLocationsFromMultiLineToken(QStringView stringLiteral,
     return result;
 }
 
-QList<int> Utils::encodeSemanticTokens(const HighlightsContainer &highlights)
+QList<int> Utils::encodeSemanticTokens(const HighlightsContainer &highlights, HighlightingMode mode)
 {
     QList<int> result;
     constexpr auto tokenEncodingLength = 5;
@@ -917,18 +927,23 @@ QList<int> Utils::encodeSemanticTokens(const HighlightsContainer &highlights)
 
     int prevLine = 0;
     int prevColumn = 0;
-
+    const auto m_mapToProtocol = mode == HighlightingMode::Default
+                                     ? mapToProtocolDefault
+                                     : mapToProtocolForQtCreator;
     std::for_each(highlights.constBegin(), highlights.constEnd(), [&](const auto &token) {
-        Q_ASSERT(token.startLine >= prevLine);
-        if (token.startLine != prevLine)
+        int length = token.loc.length;
+        int line = token.loc.startLine - 1; // protocol is 0-based
+        int col = token.loc.startColumn - 1; // protocol is 0-based
+        Q_ASSERT(line >= prevLine);
+        if (line != prevLine)
             prevColumn = 0;
-        result.emplace_back(token.startLine - prevLine);
-        result.emplace_back(token.startColumn - prevColumn);
-        result.emplace_back(token.length);
-        result.emplace_back(token.tokenType);
-        result.emplace_back(token.tokenModifier);
-        prevLine = token.startLine;
-        prevColumn = token.startColumn;
+        result.emplace_back(line - prevLine);
+        result.emplace_back(col - prevColumn);
+        result.emplace_back(length);
+        result.emplace_back(m_mapToProtocol(token.kind));
+        result.emplace_back(fromQmlModifierKindToLspTokenType(token.modifiers));
+        prevLine = line;
+        prevColumn = col;
     });
 
     return result;
@@ -1014,25 +1029,25 @@ QList<SemanticTokensEdit> Utils::computeDiff(const QList<int> &oldData, const QL
     return { std::move(edit) };
 }
 
-void HighlightingVisitor::addHighlight(const QQmlJS::SourceLocation &loc, QmlHighlightKind highlightKind,
-                              QmlHighlightModifiers modifierKind)
+void Utils::addHighlight(HighlightsContainer &out,
+                         const QQmlJS::SourceLocation &loc,
+                         QmlHighlightKind highlightKind,
+                         QmlHighlightModifiers modifierKind)
 {
     if (!loc.isValid() || loc.length == 0) {
-        qCDebug(semanticTokens) << "Invalid locations: Cannot add highlight to token";
+        qCDebug(semanticTokens)
+            << "Invalid locations: Cannot add highlight to token";
         return;
     }
-    int tokenType = m_mapToProtocol(highlightKind);
-    int modifierType = fromQmlModifierKindToLspTokenType(modifierKind);
-    if (!m_highlights.contains(loc.offset))
-        m_highlights.insert(loc.offset,HighlightToken(loc, tokenType, modifierType));
+    if (!out.contains(loc.offset))
+        out.insert(loc.offset, HighlightToken(loc, highlightKind, modifierKind));
 }
 
 HighlightsContainer Utils::visitTokens(const QQmlJS::Dom::DomItem &item,
-                                     const std::optional<HighlightsRange> &range,
-                                     HighlightingMode mode)
+                                     const std::optional<HighlightsRange> &range)
 {
     using namespace QQmlJS::Dom;
-    HighlightingVisitor highlightDomElements(item, range, mode);
+    HighlightingVisitor highlightDomElements(item, range);
     return highlightDomElements.highlights();
 }
 
@@ -1040,7 +1055,7 @@ QList<int> Utils::collectTokens(const QQmlJS::Dom::DomItem &item,
                                      const std::optional<HighlightsRange> &range,
                                      HighlightingMode mode)
 {
-    return Utils::encodeSemanticTokens(visitTokens(item, range, mode));
+    return Utils::encodeSemanticTokens(visitTokens(item, range), mode);
 }
 
 } // namespace QmlHighlighting
diff --git a/src/qmlls/qqmlsemantictokens_p.h b/src/qmlls/qqmlsemantictokens_p.h
index d5c0c6eea2..0c4d3790cc 100644
--- a/src/qmlls/qqmlsemantictokens_p.h
+++ b/src/qmlls/qqmlsemantictokens_p.h
@@ -122,34 +122,17 @@ Q_ENUM_NS(SemanticTokenProtocolTypes)
 struct HighlightToken
 {
     HighlightToken() = default;
-    HighlightToken(const QQmlJS::SourceLocation &loc, int tokenType, int tokenModifier = 0)
-        : offset(loc.offset),
-          length(loc.length),
-          startLine(loc.startLine - 1),
-          startColumn(loc.startColumn - 1),
-          tokenType(tokenType),
-          tokenModifier(tokenModifier)
-    {
-    }
-
-    inline friend bool operator<(const HighlightToken &lhs, const HighlightToken &rhs)
-    {
-        return lhs.offset < rhs.offset;
-    }
+    HighlightToken(const QQmlJS::SourceLocation &loc, QmlHighlightKind,
+                   QmlHighlightModifiers = QmlHighlightModifier::None);
 
     inline friend bool operator==(const HighlightToken &lhs, const HighlightToken &rhs)
     {
-        return lhs.offset == rhs.offset && lhs.length == rhs.length
-                && lhs.startLine == rhs.startLine && lhs.startColumn == rhs.startColumn
-                && lhs.tokenType == rhs.tokenType && lhs.tokenModifier == rhs.tokenModifier;
+        return lhs.loc == rhs.loc  && lhs.kind == rhs.kind && lhs.modifiers == rhs.modifiers;
     }
 
-    int offset;
-    int length;
-    int startLine;
-    int startColumn;
-    int tokenType;
-    int tokenModifier;
+    QQmlJS::SourceLocation loc;
+    QmlHighlightKind kind;
+    QmlHighlightModifiers modifiers;
 };
 
 using HighlightsContainer = QMap<int, HighlightToken>;
@@ -167,7 +150,7 @@ struct HighlightsRange
 
 namespace Utils
 {
-    QList<int> encodeSemanticTokens(const HighlightsContainer &highlights);
+    QList<int> encodeSemanticTokens(const HighlightsContainer &highlights, HighlightingMode mode = HighlightingMode::Default);
     QList<QQmlJS::SourceLocation>
     sourceLocationsFromMultiLineToken(QStringView code,
                                       const QQmlJS::SourceLocation &tokenLocation);
@@ -179,16 +162,16 @@ namespace Utils
                              const std::optional<HighlightsRange> &range,
                              HighlightingMode mode = HighlightingMode::Default);
     HighlightsContainer visitTokens(const QQmlJS::Dom::DomItem &item,
-                                 const std::optional<HighlightsRange> &range,
-                                 HighlightingMode mode = HighlightingMode::Default);
+                                 const std::optional<HighlightsRange> &range);
+    void addHighlight(HighlightsContainer &out, const QQmlJS::SourceLocation &loc, QmlHighlightKind,
+                      QmlHighlightModifiers = QmlHighlightModifier::None);
 } // namespace Utils
 
 class HighlightingVisitor
 {
 public:
     HighlightingVisitor(const QQmlJS::Dom::DomItem &item,
-                        const std::optional<HighlightsRange> &range,
-                        HighlightingMode mode = HighlightingMode::Default);
+                        const std::optional<HighlightsRange> &range);
     const HighlightsContainer &hightights() const { return m_highlights; }
     HighlightsContainer &highlights() { return m_highlights; }
 
@@ -215,7 +198,6 @@ private:
 private:
     HighlightsContainer m_highlights;
     std::optional<HighlightsRange> m_range;
-    QmlHighlightKindToLspKind m_mapToProtocol;
 };
 
 } // namespace QmlHighlighting
diff --git a/tests/auto/qmlls/utils/tst_qmlls_highlighting.cpp b/tests/auto/qmlls/utils/tst_qmlls_highlighting.cpp
index 231dc4fd23..6dae204bb0 100644
--- a/tests/auto/qmlls/utils/tst_qmlls_highlighting.cpp
+++ b/tests/auto/qmlls/utils/tst_qmlls_highlighting.cpp
@@ -29,44 +29,63 @@ void tst_qmlls_highlighting::encodeSemanticTokens_data()
     QTest::addColumn<HighlightsContainer>("highlights");
     QTest::addColumn<QList<int>>("expectedMemoryLayout");
 
+    // The magic numbers below are used for semantic token encoding:
+    // Each token is represented by 5 integers:
+    // [deltaLine, deltaStartChar, length, tokenType, tokenModifiers]
+    // For example:
+    // - tokenType 25 means QmlHighlightKind::Unknown is map
+    // - tokenType 1 means QmlHighlightKind::QmlType
+    // - tokenModifiers 2 means QmlHighlightModifier::QmlPropertyDefinition
+    // These values are mapped according to the enums in QmlHighlightKind and QmlHighlightModifier and using
+    //  the mapper function mapToProtocolDefault(...)
     {
         HighlightsContainer c;
-        c.insert(0, HighlightToken());
-        QTest::addRow("empty-token-single") << c << QList {0, 0, 0, 0, 0};
+        HighlightToken t(QQmlJS::SourceLocation(0, 0, 1, 1), QmlHighlightKind::Unknown, QmlHighlightModifier::None);
+        c.insert(t.loc.offset, t);
+        QTest::addRow("empty-token-single") << c << QList {0, 0, 0, 25, 0};
     }
     {
         HighlightsContainer c;
-        QQmlJS::SourceLocation loc(0, 1, 1, 1);
-        c.insert(0, HighlightToken(loc, 0, 0));
-        QTest::addRow("single-token") << c << QList {0, 0, 1, 0, 0};
+        HighlightToken t(QQmlJS::SourceLocation(0, 1, 1, 1), QmlHighlightKind::Unknown, QmlHighlightModifier::None);
+        c.insert(t.loc.offset, t);
+        QTest::addRow("single-token") << c << QList {0, 0, 1, 25, 0};
     }
     {
         HighlightsContainer c;
-        HighlightToken t1(QQmlJS::SourceLocation(0, 1, 1, 1), 0, 0);
-        HighlightToken t2(QQmlJS::SourceLocation(1, 1, 3, 3), 0, 0);
-        c.insert(t1.offset, t1);
-        c.insert(t2.offset, t2);
-        QTest::addRow("different-lines") << c << QList {0, 0, 1, 0, 0, 2, 2, 1, 0, 0};
+        HighlightToken t1(QQmlJS::SourceLocation(0, 1, 1, 1), QmlHighlightKind::Unknown, QmlHighlightModifier::None);
+        HighlightToken t2(QQmlJS::SourceLocation(1, 1, 3, 3), QmlHighlightKind::Unknown, QmlHighlightModifier::None);
+        c.insert(t1.loc.offset, t1);
+        c.insert(t2.loc.offset, t2);
+        QTest::addRow("different-lines") << c << QList {0, 0, 1, 25, 0, 2, 2, 1, 25, 0};
     }
     {
         HighlightsContainer c;
-        HighlightToken t1(QQmlJS::SourceLocation(0, 1, 1, 1), 0, 0);
-        HighlightToken t2(QQmlJS::SourceLocation(1, 1, 1, 3), 0, 0);
-        c.insert(t1.offset, t1);
-        c.insert(t2.offset, t2);
-        QTest::addRow("same-line-different-column") << c << QList {0, 0, 1, 0, 0, 0, 2, 1, 0, 0};
+        HighlightToken t1;
+        t1.loc = QQmlJS::SourceLocation(0, 1, 1, 1);
+        t1.kind = QmlHighlightKind::Unknown;
+        HighlightToken t2;
+        t2.loc = QQmlJS::SourceLocation(1, 1, 1, 3);
+        t2.kind = QmlHighlightKind::Unknown;
+        c.insert(t1.loc.offset, t1);
+        c.insert(t2.loc.offset, t2);
+        QTest::addRow("same-line-different-column") << c << QList {0, 0, 1, 25, 0, 0, 2, 1, 25, 0};
     }
     {
         HighlightsContainer c;
-        HighlightToken t1(QQmlJS::SourceLocation(0, 1, 1, 1), 1, 0);
-        c.insert(t1.offset, t1);
+        HighlightToken t1;
+        t1.loc = QQmlJS::SourceLocation(0, 1, 1, 1);
+        t1.kind = QmlHighlightKind::QmlType;
+        c.insert(t1.loc.offset, t1);
         QTest::addRow("token-type") << c << QList {0, 0, 1, 1, 0};
     }
     {
         HighlightsContainer c;
-        HighlightToken t1(QQmlJS::SourceLocation(0, 1, 1, 1), 1, 1);
-        c.insert(t1.offset, t1);
-        QTest::addRow("token-modifier") << c << QList {0, 0, 1, 1, 1};
+        HighlightToken t1;
+        t1.loc = QQmlJS::SourceLocation(0, 1, 1, 1);
+        t1.kind = QmlHighlightKind::QmlType;
+        t1.modifiers = QmlHighlightModifier::QmlPropertyDefinition;
+        c.insert(t1.loc.offset, t1);
+        QTest::addRow("token-modifier") << c << QList {0, 0, 1, 1, 2};
     }
 }
 
@@ -74,8 +93,16 @@ void tst_qmlls_highlighting::encodeSemanticTokens()
 {
     QFETCH(HighlightsContainer, highlights);
     QFETCH(QList<int>, expectedMemoryLayout);
+
     const auto encoded = Utils::encodeSemanticTokens(highlights);
-    QCOMPARE(encoded, expectedMemoryLayout);
+    [&]() {
+        QCOMPARE(encoded, expectedMemoryLayout);
+    }();
+
+    if (QTest::currentTestFailed()) {
+        qDebug() << "Actual encoded tokens: " << encoded;
+        qDebug() << "Expected encoded tokens: " << expectedMemoryLayout;
+    }
 }
 
 struct LineLength
@@ -172,37 +199,36 @@ void tst_qmlls_highlighting::highlights_data()
     { // Comments
         const auto filePath = m_highlightingDataDir + "/comments.qml";
         const auto fileItem = fileObject(filePath);
-        // Copyright (C) 2023 The Qt Company Ltd.
         QTest::addRow("single-line-1")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(0, 41, 1, 1),
-                         int(SemanticTokenProtocolTypes::Comment), 0);
+                         QmlHighlightKind::Comment, QmlHighlightModifier::None);
 
         /* single line comment    */
         QTest::addRow("single-line-2")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(162, 28, 9, 1),
-                         int(SemanticTokenProtocolTypes::Comment), 0);
+                         QmlHighlightKind::Comment, QmlHighlightModifier::None);
 
         // Multiline comments are split into multiple locations
         QTest::addRow("multiline-first-line")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(133, 2, 5, 1),
-                         int(SemanticTokenProtocolTypes::Comment), 0);
+                         QmlHighlightKind::Comment, QmlHighlightModifier::None);
         QTest::addRow("multiline-second-line")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(136, 21, 6, 1),
-                         int(SemanticTokenProtocolTypes::Comment), 0);
+                         QmlHighlightKind::Comment, QmlHighlightModifier::None);
         QTest::addRow("multiline-third-line")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(158, 2, 7, 1),
-                         int(SemanticTokenProtocolTypes::Comment), 0);
+                         QmlHighlightKind::Comment, QmlHighlightModifier::None);
 
         // Comments Inside Js blocks
         QTest::addRow("inside-js")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(232, 5, 13, 9),
-                         int(SemanticTokenProtocolTypes::Comment), 0);
+                         QmlHighlightKind::Comment, QmlHighlightModifier::None);
     }
     { // Imports
         const auto filePath = m_highlightingDataDir + "/imports.qml";
@@ -210,27 +236,27 @@ void tst_qmlls_highlighting::highlights_data()
         QTest::addRow("import-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(112, 6, 4, 1),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("module-uri")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(119, 7, 4, 8),
-                         int(SemanticTokenProtocolTypes::Namespace), 0);
+                         QmlHighlightKind::QmlImportId, QmlHighlightModifier::None);
         QTest::addRow("directory-uri")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(152, 3, 6, 8),
-                         int(SemanticTokenProtocolTypes::String), 0);
+                         QmlHighlightKind::String, QmlHighlightModifier::None);
         QTest::addRow("as-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(156, 2, 6, 12),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("version-number")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(140, 4, 5, 14),
-                         int(SemanticTokenProtocolTypes::Number), 0);
+                         QmlHighlightKind::Number, QmlHighlightModifier::None);
         QTest::addRow("qualified-namespace")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(159, 6, 6, 15),
-                         int(SemanticTokenProtocolTypes::Namespace), 0);
+                         QmlHighlightKind::QmlNamespace, QmlHighlightModifier::None);
     }
     { // Bindings
         const auto filePath = m_highlightingDataDir + "/bindings.qml";
@@ -240,16 +266,16 @@ void tst_qmlls_highlighting::highlights_data()
         QTest::addRow("normalBinding")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(189, 1, 11, 5),
-                         int(SemanticTokenProtocolTypes::Property), 0);
+                         QmlHighlightKind::QmlProperty, QmlHighlightModifier::None);
         // on binding
         QTest::addRow("on-binding")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(175, 5, 9, 17),
-                         int(SemanticTokenProtocolTypes::Property), 0);
+                         QmlHighlightKind::QmlProperty, QmlHighlightModifier::None);
         QTest::addRow("on-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(172, 2, 9, 14),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
     }
     { // Pragmas
         const auto filePath = m_highlightingDataDir + "/pragmas.qml";
@@ -257,43 +283,43 @@ void tst_qmlls_highlighting::highlights_data()
         QTest::addRow("pragma-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(112, 6, 4, 1),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("pragma-name")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(136, 25, 5, 8),
-                         int(SemanticTokenProtocolTypes::Variable), 0);
+                         QmlHighlightKind::QmlPragmaName, QmlHighlightModifier::None);
         QTest::addRow("pragma-value")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(198, 4, 6, 27),
-                         int(SemanticTokenProtocolTypes::Variable), 0);
+                         QmlHighlightKind::QmlPragmaValue, QmlHighlightModifier::None);
     }
     { // Enums
         const auto filePath = m_highlightingDataDir + "/enums.qml";
         const auto fileItem = fileObject(filePath);
         QTest::addRow("enum-keyword") << fileItem
                                       << HighlightToken(QQmlJS::SourceLocation(158, 4, 8, 5),
-                                               int(SemanticTokenProtocolTypes::Keyword), 0);
+                                               QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("enum-name") << fileItem
                                    << HighlightToken(QQmlJS::SourceLocation(163, 3, 8, 10),
-                                            int(SemanticTokenProtocolTypes::Enum), 0);
+                                            QmlHighlightKind::QmlEnumName, QmlHighlightModifier::None);
         QTest::addRow("enum-item") << fileItem
                                    << HighlightToken(QQmlJS::SourceLocation(177, 3, 9, 9),
-                                            int(SemanticTokenProtocolTypes::EnumMember), 0);
+                                            QmlHighlightKind::QmlEnumMember, QmlHighlightModifier::None);
         QTest::addRow("enum-value") << fileItem
                                     << HighlightToken(QQmlJS::SourceLocation(196, 1, 10, 15),
-                                             int(SemanticTokenProtocolTypes::Number), 0);
+                                             QmlHighlightKind::Number, QmlHighlightModifier::None);
         QTest::addRow("namespace-enum") << fileItem
                                         << HighlightToken(QQmlJS::SourceLocation(225, 1, 13, 21),
-                                                 int(SemanticTokenProtocolTypes::Namespace), 0);
+                                                 QmlHighlightKind::QmlNamespace, QmlHighlightModifier::None);
         QTest::addRow("component-enum") << fileItem
                                         << HighlightToken(QQmlJS::SourceLocation(227, 11, 13, 23),
-                                                 int(SemanticTokenProtocolTypes::Type), 0);
+                                                 QmlHighlightKind::QmlType, QmlHighlightModifier::None);
         QTest::addRow("enum-name-1") << fileItem
                                      << HighlightToken(QQmlJS::SourceLocation(239, 1, 13, 35),
-                                              int(SemanticTokenProtocolTypes::Enum), 0);
+                                              QmlHighlightKind::QmlEnumName, QmlHighlightModifier::None);
         QTest::addRow("enum-member-1") << fileItem
                                        << HighlightToken(QQmlJS::SourceLocation(241, 4, 13, 37),
-                                                int(SemanticTokenProtocolTypes::EnumMember), 0);
+                                                QmlHighlightKind::QmlEnumMember, QmlHighlightModifier::None);
     }
     { // objects and inline components
         const auto filePath = m_highlightingDataDir + "/objectAndComponent.qml";
@@ -303,84 +329,79 @@ void tst_qmlls_highlighting::highlights_data()
         QTest::addRow("object-identifier")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(169, 4, 8, 5),
-                         int(SemanticTokenProtocolTypes::Type), 0);
+                         QmlHighlightKind::QmlType, QmlHighlightModifier::None);
         QTest::addRow("object-id-property")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(184, 2, 9, 9),
-                         int(SemanticTokenProtocolTypes::Property), 0);
+                         QmlHighlightKind::QmlProperty, QmlHighlightModifier::None);
         QTest::addRow("object-id-name")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(188, 5, 9, 13),
-                         int(SemanticTokenProtocolTypes::Variable), 0);
+                         QmlHighlightKind::QmlLocalId, QmlHighlightModifier::None);
 
         // component
         QTest::addRow("component-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(139, 9, 7, 5),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("component-name")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(149, 6, 7, 15),
-                         int(SemanticTokenProtocolTypes::Type), 0);
+                         QmlHighlightKind::QmlType, QmlHighlightModifier::None);
     }
     { // property definition
         const auto filePath = m_highlightingDataDir + "/properties.qml";
         const auto fileItem = fileObject(filePath);
 
-        int definitionModifier = 1 << int(SemanticTokenModifiers::Definition);
         QTest::addRow("property-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(154, 8, 8, 9),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("property-type")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(163, 3, 8, 18),
-                         int(SemanticTokenProtocolTypes::Type), 0);
+                         QmlHighlightKind::QmlType, QmlHighlightModifier::None);
         QTest::addRow("property-name")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(167, 1, 8, 22),
-                         int(SemanticTokenProtocolTypes::Property),
-                         definitionModifier);
-        int readOnlyModifier = definitionModifier | (1 << int(SemanticTokenModifiers::Readonly));
+                         QmlHighlightKind::QmlProperty,
+                         QmlHighlightModifier::QmlPropertyDefinition);
         QTest::addRow("readonly-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(177, 8, 9, 9),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("readonly-modifier")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(199, 2, 9, 31),
-                         int(SemanticTokenProtocolTypes::Property),
-                         readOnlyModifier);
-        int requiredModifier = definitionModifier | (1 << int(SemanticTokenModifiers::Abstract));
+                         QmlHighlightKind::QmlProperty,
+                         QmlHighlightModifier::QmlPropertyDefinition | QmlHighlightModifier::QmlReadonlyProperty);
         QTest::addRow("required-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(210, 8, 10, 9),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("required-modifier")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(232, 3, 10, 31),
-                         int(SemanticTokenProtocolTypes::Property),
-                         requiredModifier);
-        int defaultModifier =
-                definitionModifier | (1 << int(SemanticTokenModifiers::DefaultLibrary));
+                         QmlHighlightKind::QmlProperty,
+                         QmlHighlightModifier::QmlPropertyDefinition | QmlHighlightModifier::QmlRequiredProperty);
         QTest::addRow("default-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(244, 7, 11, 9),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("default-modifier")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(265, 4, 11, 30),
-                         int(SemanticTokenProtocolTypes::Property), defaultModifier);
-        int finalModifier =
-                definitionModifier | (1 << int(SemanticTokenModifiers::Static));
+                         QmlHighlightKind::QmlProperty,
+                         QmlHighlightModifier::QmlPropertyDefinition | QmlHighlightModifier::QmlDefaultProperty);
         QTest::addRow("final-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(278, 5, 12, 9),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("final-modifier")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(297, 5, 12, 28),
-                         int(SemanticTokenProtocolTypes::Property), finalModifier);
+                         QmlHighlightKind::QmlProperty,
+                         QmlHighlightModifier::QmlPropertyDefinition | QmlHighlightModifier::QmlFinalProperty);
     }
     {
         // methods and signals, lambda functions
@@ -390,63 +411,63 @@ void tst_qmlls_highlighting::highlights_data()
         QTest::addRow("signal-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(139, 6, 7, 5),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("signal-name")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(146, 1, 7, 12),
-                         int(SemanticTokenProtocolTypes::Method), 0);
+                         QmlHighlightKind::QmlMethod, QmlHighlightModifier::None);
         QTest::addRow("signal-type")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(163, 3, 8, 14),
-                         int(SemanticTokenProtocolTypes::Type), 0);
+                         QmlHighlightKind::QmlType, QmlHighlightModifier::None);
         QTest::addRow("signal-type-2")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(186, 3, 9, 17),
-                         int(SemanticTokenProtocolTypes::Type), 0);
+                         QmlHighlightKind::QmlType, QmlHighlightModifier::None);
         QTest::addRow("function-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(195, 8, 10, 5),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("function-name")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(204, 1, 10, 14),
-                         int(SemanticTokenProtocolTypes::Method), 0);
+                         QmlHighlightKind::QmlMethod, QmlHighlightModifier::None);
         QTest::addRow("function-prm-type")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(209, 3, 10, 19),
-                         int(SemanticTokenProtocolTypes::Type), 0);
+                         QmlHighlightKind::QmlType, QmlHighlightModifier::None);
         QTest::addRow("function-prm-name")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(206, 1, 10, 16),
-                         int(SemanticTokenProtocolTypes::Parameter), 0);
+                         QmlHighlightKind::QmlMethodParameter, QmlHighlightModifier::None);
         QTest::addRow("function-rtn-type")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(216, 3, 10, 26),
-                         int(SemanticTokenProtocolTypes::Type), 0);
+                         QmlHighlightKind::QmlType, QmlHighlightModifier::None);
         // lambda function keywords
         QTest::addRow("function-keyword-rhs")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(344, 8, 16, 24),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("function-keyword-rhs-1")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(441, 8, 19, 20),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("function-keyword-in-function-body")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(536, 8, 21, 9),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("nested-function-identifier")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(545, 6, 21, 18),
-                         int(SemanticTokenProtocolTypes::Method), 0);
+                         QmlHighlightKind::QmlMethod, QmlHighlightModifier::None);
         QTest::addRow("lambda-undefined-arg") << fileItem
                                               << HighlightToken(QQmlJS::SourceLocation(409, 1, 17, 33),
-                                                       int(SemanticTokenProtocolTypes::Unknown), 0);
+                                                       QmlHighlightKind::Unknown, QmlHighlightModifier::None);
         QTest::addRow("yield-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(697, 5, 25, 50),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
     }
     { // literals
         const auto filePath = m_highlightingDataDir + "/literals.qml";
@@ -454,62 +475,62 @@ void tst_qmlls_highlighting::highlights_data()
 
         QTest::addRow("number") << fileItem
                                 << HighlightToken(QQmlJS::SourceLocation(155, 3, 7, 21),
-                                         int(SemanticTokenProtocolTypes::Number), 0);
+                                         QmlHighlightKind::Number, QmlHighlightModifier::None);
         QTest::addRow("singleline-string")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(182, 8, 8, 24),
-                         int(SemanticTokenProtocolTypes::String), 0);
+                         QmlHighlightKind::String, QmlHighlightModifier::None);
         QTest::addRow("multiline-string-first")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(214, 6, 9, 24),
-                         int(SemanticTokenProtocolTypes::String), 0);
+                         QmlHighlightKind::String, QmlHighlightModifier::None);
         QTest::addRow("multiline-string-second")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(221, 16, 10, 1),
-                         int(SemanticTokenProtocolTypes::String), 0);
+                         QmlHighlightKind::String, QmlHighlightModifier::None);
         QTest::addRow("multiline-with-newlines-l1")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(313, 10, 13, 24),
-                         int(SemanticTokenProtocolTypes::String), 0);
+                         QmlHighlightKind::String, QmlHighlightModifier::None);
         QTest::addRow("multiline-with-newlines-l2")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(324, 16, 14, 1),
-                         int(SemanticTokenProtocolTypes::String), 0);
+                         QmlHighlightKind::String, QmlHighlightModifier::None);
         QTest::addRow("boolean") << fileItem
                                  << HighlightToken(QQmlJS::SourceLocation(260, 4, 11, 22),
-                                          int(SemanticTokenProtocolTypes::Keyword),
-                                          0);
+                                          QmlHighlightKind::QmlKeyword,
+                                          QmlHighlightModifier::None);
         QTest::addRow("null") << fileItem
                               << HighlightToken(QQmlJS::SourceLocation(285, 4, 12, 21),
-                                       int(SemanticTokenProtocolTypes::Keyword), 0);
+                                       QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("leftbacktick") << fileItem
                                       << HighlightToken(QQmlJS::SourceLocation(390, 1, 17, 43),
-                                               int(SemanticTokenProtocolTypes::String), 0);
+                                               QmlHighlightKind::String, QmlHighlightModifier::None);
         QTest::addRow("rightbacktick") << fileItem
                                        << HighlightToken(QQmlJS::SourceLocation(424, 1, 20, 5),
-                                                int(SemanticTokenProtocolTypes::String), 0);
+                                                QmlHighlightKind::String, QmlHighlightModifier::None);
         QTest::addRow("templatestringpartStart") << fileItem
                                             << HighlightToken(QQmlJS::SourceLocation(391, 5, 17, 44),
-                                                     int(SemanticTokenProtocolTypes::String), 0);
+                                                     QmlHighlightKind::String, QmlHighlightModifier::None);
         QTest::addRow("templatestringpartEnd") << fileItem
                                             << HighlightToken(QQmlJS::SourceLocation(412, 7, 19, 1),
-                                                     int(SemanticTokenProtocolTypes::String), 0);
+                                                     QmlHighlightKind::String, QmlHighlightModifier::None);
         QTest::addRow("templateExpressionPartB")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(403, 1, 18, 7),
-                         int(SemanticTokenProtocolTypes::Property), 0);
+                         QmlHighlightKind::QmlScopeObjectProperty, QmlHighlightModifier::None);
         QTest::addRow("templateExpressionPartK")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(407, 1, 18, 11),
-                         int(SemanticTokenProtocolTypes::Method), 0);
+                         QmlHighlightKind::QmlMethod, QmlHighlightModifier::None);
         QTest::addRow("dollarLeftBrace")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(401, 2, 18, 5),
-                         int(SemanticTokenProtocolTypes::Operator), 0);
+                         QmlHighlightKind::Operator, QmlHighlightModifier::None);
         QTest::addRow("rightbrace")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(410, 1, 18, 14),
-                         int(SemanticTokenProtocolTypes::Operator), 0);
+                         QmlHighlightKind::Operator, QmlHighlightModifier::None);
     }
     { // identifiers
         const auto filePath = m_highlightingDataDir + "/Identifiers.qml";
@@ -517,45 +538,45 @@ void tst_qmlls_highlighting::highlights_data()
         QTest::addRow("js-property")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(222, 3, 10, 13),
-                         int(SemanticTokenProtocolTypes::Variable), 0);
+                         QmlHighlightKind::JsScopeVar, QmlHighlightModifier::None);
         QTest::addRow("property-id")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(302, 4, 12, 19),
-                         int(SemanticTokenProtocolTypes::Property),
-                         (1 << int(SemanticTokenModifiers::Readonly)));
+                         QmlHighlightKind::QmlScopeObjectProperty,
+                         QmlHighlightModifier::QmlReadonlyProperty);
         QTest::addRow("property-changed")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(451, 11, 18, 9),
-                         int(SemanticTokenProtocolTypes::Method), 0);
+                         QmlHighlightKind::QmlMethod, QmlHighlightModifier::None);
         QTest::addRow("signal") << fileItem
                                 << HighlightToken(QQmlJS::SourceLocation(474, 7, 19, 9),
-                                         int(SemanticTokenProtocolTypes::Method), 0);
+                                         QmlHighlightKind::QmlMethod, QmlHighlightModifier::None);
 
         QTest::addRow("attached-id")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(512, 4, 23, 5),
-                         int(SemanticTokenProtocolTypes::Type), 0);
+                         QmlHighlightKind::QmlType, QmlHighlightModifier::None);
         QTest::addRow("attached-signalhandler")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(517, 9, 23, 10),
-                         int(SemanticTokenProtocolTypes::Property), 0);
+                         QmlHighlightKind::Field, QmlHighlightModifier::None);
         QTest::addRow("propchanged-handler") << fileItem
                                              << HighlightToken(QQmlJS::SourceLocation(572, 13, 27, 5),
-                                                      int(SemanticTokenProtocolTypes::Property), 0);
+                                                      QmlHighlightKind::QmlProperty, QmlHighlightModifier::None);
         QTest::addRow("method-id")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(597, 1, 28, 9),
-                         int(SemanticTokenProtocolTypes::Method), 0);
+                         QmlHighlightKind::QmlMethod, QmlHighlightModifier::None);
         QTest::addRow("signal-handler") << fileItem
                                         << HighlightToken(QQmlJS::SourceLocation(656, 9, 32, 5),
-                                                 int(SemanticTokenProtocolTypes::Property), 0);
+                                                 QmlHighlightKind::QmlProperty, QmlHighlightModifier::None);
 
         QTest::addRow("enum-name-usage") << fileItem
                                          << HighlightToken(QQmlJS::SourceLocation(790, 1, 36, 35),
-                                                  int(SemanticTokenProtocolTypes::Enum), 0);
+                                                  QmlHighlightKind::QmlEnumName, QmlHighlightModifier::None);
         QTest::addRow("enum-member-usage") << fileItem
                                            << HighlightToken(QQmlJS::SourceLocation(792, 4, 36, 37),
-                                                    int(SemanticTokenProtocolTypes::EnumMember), 0);
+                                                    QmlHighlightKind::QmlEnumMember, QmlHighlightModifier::None);
     }
     { // script expressions
         const auto filePath = m_highlightingDataDir + "/scriptExpressions.qml";
@@ -564,137 +585,136 @@ void tst_qmlls_highlighting::highlights_data()
         QTest::addRow("var-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(192, 3, 11, 9),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("const-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(217, 5, 12, 9),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
-        const auto modifier = (1 << int(SemanticTokenModifiers::Readonly));
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("const-name")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(223, 10, 12, 15),
-                         int(SemanticTokenProtocolTypes::Variable), modifier);
+                         QmlHighlightKind::JsScopeVar, QmlHighlightModifier::QmlReadonlyProperty);
         QTest::addRow("do-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(248, 2, 13, 9),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("if-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(287, 2, 15, 13),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("continue-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(319, 8, 16, 17),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("else-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(341, 4, 17, 13),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("while-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(382, 5, 19, 11),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("switch-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(418, 6, 20, 9),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("case-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(444, 4, 21, 9),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("return-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(464, 6, 22, 13),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("default-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(483, 7, 23, 9),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("break-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(504, 5, 24, 13),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("try-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(529, 3, 26, 9),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("catch-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(560, 5, 28, 11),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("finally-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(601, 7, 30, 11),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("for-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(620, 3, 31, 9),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("throw-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(661, 5, 32, 13),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("for-declaration")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(625, 5, 31, 14),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("destructuring")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(1511, 2, 73, 16),
-                         int(SemanticTokenProtocolTypes::Variable),
-                         (1 << int(SemanticTokenModifiers::Readonly)));
+                         QmlHighlightKind::JsScopeVar,
+                         QmlHighlightModifier::QmlReadonlyProperty);
         QTest::addRow("obj-destructuring")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(1589, 2, 76, 17),
-                         int(SemanticTokenProtocolTypes::Variable),
-                         (1 << int(SemanticTokenModifiers::Readonly)));
+                         QmlHighlightKind::JsScopeVar,
+                         QmlHighlightModifier::QmlReadonlyProperty);
         QTest::addRow("this-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(2661, 4, 115, 19),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("super-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(2677, 5, 116, 9),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
         QTest::addRow("new-keyword")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(2718, 3, 118, 16),
-                         int(SemanticTokenProtocolTypes::Keyword), 0);
+                         QmlHighlightKind::QmlKeyword, QmlHighlightModifier::None);
     }
     { // namespaced items
         const auto filePath = m_highlightingDataDir + "/namespace.qml";
         const auto fileItem = fileObject(filePath);
         QTest::addRow("namespace") << fileItem
                                    << HighlightToken(QQmlJS::SourceLocation(134, 3, 5, 1),
-                                   int(SemanticTokenProtocolTypes::Namespace), 0);
+                                   QmlHighlightKind::QmlNamespace, QmlHighlightModifier::None);
         QTest::addRow("type") << fileItem
                                    << HighlightToken(QQmlJS::SourceLocation(138, 4, 5, 5),
-                                   int(SemanticTokenProtocolTypes::Type), 0);
+                                   QmlHighlightKind::QmlType, QmlHighlightModifier::None);
     }
     { // miscellaneous
         const auto filePath = m_highlightingDataDir + "/misc.qml";
         const auto fileItem = fileObject(filePath);
         QTest::addRow("typeModifiers") << fileItem
                                    << HighlightToken(QQmlJS::SourceLocation(147, 4, 6, 14),
-                                   int(SemanticTokenProtocolTypes::Decorator), 0);
+                                   QmlHighlightKind::QmlTypeModifier, QmlHighlightModifier::None);
         QTest::addRow("globalVar") << fileItem
                                    << HighlightToken(QQmlJS::SourceLocation(234, 4, 9, 19),
-                                            int(SemanticTokenProtocolTypes::Variable), 0);
+                                            QmlHighlightKind::JsGlobalVar, QmlHighlightModifier::None);
         QTest::addRow("globalMethod") << fileItem
                                       << HighlightToken(QQmlJS::SourceLocation(239, 3, 9, 24),
-                                               int(SemanticTokenProtocolTypes::Method), 0);
+                                               QmlHighlightKind::QmlMethod, QmlHighlightModifier::None);
         QTest::addRow("globalMethodNewMember") << fileItem
                                                << HighlightToken(QQmlJS::SourceLocation(267, 4, 10, 23),
-                                                        int(SemanticTokenProtocolTypes::Method), 0);
+                                                        QmlHighlightKind::JsGlobalMethod, QmlHighlightModifier::None);
         QTest::addRow("globalMethodCallExpr") << fileItem
                                               << HighlightToken(QQmlJS::SourceLocation(310, 4, 11, 36),
-                                                       int(SemanticTokenProtocolTypes::Method), 0);
+                                                       QmlHighlightKind::QmlMethod, QmlHighlightModifier::None);
         QTest::addRow("globalVarCallExpr") << fileItem
                                            << HighlightToken(QQmlJS::SourceLocation(300, 9, 11, 26),
-                                                    int(SemanticTokenProtocolTypes::Property), 0);
+                                                    QmlHighlightKind::Field, QmlHighlightModifier::None);
         QTest::addRow("globalVarMath") << fileItem
                                        << HighlightToken(QQmlJS::SourceLocation(337, 4, 12, 20),
-                                                int(SemanticTokenProtocolTypes::Variable), 0);
+                                                QmlHighlightKind::JsGlobalVar, QmlHighlightModifier::None);
     }
     { // property chains
         const auto filePath = m_highlightingDataDir + "/propertyChains.qml";
@@ -702,68 +722,68 @@ void tst_qmlls_highlighting::highlights_data()
         QTest::addRow("knownMemberOfInnerScope1")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(411, 3, 19, 13),
-                         int(SemanticTokenProtocolTypes::Property), 0);
+                         QmlHighlightKind::QmlScopeObjectProperty, QmlHighlightModifier::None);
         QTest::addRow("knownMemberOfInnerScope2")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(415, 3, 19, 17),
-                         int(SemanticTokenProtocolTypes::Property), 0);
+                         QmlHighlightKind::Field, QmlHighlightModifier::None);
         QTest::addRow("knownMemberOfInnerScope3")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(419, 3, 19, 21),
-                         int(SemanticTokenProtocolTypes::Property), 0);
+                         QmlHighlightKind::Field, QmlHighlightModifier::None);
         QTest::addRow("idInsideTheSameComponent1")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(688, 4, 33, 17),
-                         int(SemanticTokenProtocolTypes::Variable), 0);
+                         QmlHighlightKind::QmlLocalId, QmlHighlightModifier::None);
         QTest::addRow("idInsideTheSameComponent2")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(693, 5, 33, 22),
-                         int(SemanticTokenProtocolTypes::Property), 0);
+                         QmlHighlightKind::Field, QmlHighlightModifier::None);
         QTest::addRow("idInsideTheSameComponent3")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(699, 8, 33, 28),
-                         int(SemanticTokenProtocolTypes::Method), 0);
-        QTest::addRow("knownMemberOfParentScope1")
+                         QmlHighlightKind::QmlMethod, QmlHighlightModifier::None);
+        QTest::addRow("unknownMemberOfParentScope1")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(993, 12, 47, 33),
-                         int(SemanticTokenProtocolTypes::Property), 0);
+                         QmlHighlightKind::QmlExternalObjectProperty, QmlHighlightModifier::None);
         QTest::addRow("unresolvedLookup1") << fileItem
                                            << HighlightToken(QQmlJS::SourceLocation(1177, 3, 56, 13),
-                                                    int(SemanticTokenProtocolTypes::Unknown), 0);
+                                                    QmlHighlightKind::Unknown, QmlHighlightModifier::None);
         QTest::addRow("unresolvedLookup2") << fileItem
                                            << HighlightToken(QQmlJS::SourceLocation(1181, 3, 56, 17),
-                                                    int(SemanticTokenProtocolTypes::Property), 0);
+                                                    QmlHighlightKind::Field, QmlHighlightModifier::None);
         QTest::addRow("outerIDLookupInNestedComponent1")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(1480, 5, 69, 21),
-                         int(SemanticTokenProtocolTypes::Variable), 0);
+                         QmlHighlightKind::QmlExternalId, QmlHighlightModifier::None);
         QTest::addRow("outerIDLookupInNestedComponent2")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(1486, 5, 69, 27),
-                         int(SemanticTokenProtocolTypes::Property), 0);
+                         QmlHighlightKind::Field, QmlHighlightModifier::None);
         QTest::addRow("outerIDLookupInNestedComponent3")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(1492, 7, 69, 33),
-                         int(SemanticTokenProtocolTypes::Method), 0);
+                         QmlHighlightKind::QmlMethod, QmlHighlightModifier::None);
         QTest::addRow("attachedPropertyChain1")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(1799, 7, 82, 17),
-                         int(SemanticTokenProtocolTypes::Variable), 0);
+                         QmlHighlightKind::QmlLocalId, QmlHighlightModifier::None);
         QTest::addRow("attachedPropertyChain2")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(1807, 11, 82, 25),
-                         int(SemanticTokenProtocolTypes::Property), 0);
+                         QmlHighlightKind::Field, QmlHighlightModifier::None);
         QTest::addRow("attachedPropertyChain3")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(1819, 11, 82, 37),
-                         int(SemanticTokenProtocolTypes::Method), 0);
+                         QmlHighlightKind::QmlMethod, QmlHighlightModifier::None);
     }
     { // method in property chains
         const auto filePath = m_highlightingDataDir + "/methodInPropertyChains.qml";
         const auto fileItem = fileObject(filePath);
         QTest::addRow("chainedMethodName") << fileItem
                                            << HighlightToken(QQmlJS::SourceLocation(271, 11, 11, 60),
-                                                    int(SemanticTokenProtocolTypes::Method), 0);
+                                                    QmlHighlightKind::QmlMethod, QmlHighlightModifier::None);
     }
     { // known member of parent scope
         const auto filePath = m_highlightingDataDir + "/componentBound.qml";
@@ -771,7 +791,7 @@ void tst_qmlls_highlighting::highlights_data()
         QTest::addRow("outerIDWithComponentBound")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(296, 5, 15, 17),
-                         int(SemanticTokenProtocolTypes::Variable), 0);
+                         QmlHighlightKind::QmlLocalId, QmlHighlightModifier::None);
     }
     { // known member of parent scope with no component bound
         const auto filePath = m_highlightingDataDir + "/componentNoBound.qml";
@@ -779,7 +799,7 @@ void tst_qmlls_highlighting::highlights_data()
         QTest::addRow("outerIDWithNoComponentBound")
                 << fileItem
                 << HighlightToken(QQmlJS::SourceLocation(296, 5, 15, 17),
-                         int(SemanticTokenProtocolTypes::Variable), 0);
+                         QmlHighlightKind::QmlExternalId, QmlHighlightModifier::None);
     }
 }
 
@@ -792,26 +812,26 @@ void tst_qmlls_highlighting::highlights()
     const auto highlights = Utils::visitTokens(fileItem,std::nullopt);
 
     [&]() {
-        QVERIFY(highlights.contains(expectedHighlightedToken.offset));
-        QCOMPARE(highlights.value(expectedHighlightedToken.offset), expectedHighlightedToken);
+        QVERIFY(highlights.contains(expectedHighlightedToken.loc.offset));
+        QCOMPARE(highlights.value(expectedHighlightedToken.loc.offset), expectedHighlightedToken);
     }();
 
     if (QTest::currentTestFailed()) {
-        const auto [a1, b1, c1, d1, e1, f1] = expectedHighlightedToken;
+        const auto& expected = expectedHighlightedToken;
 
-        if (highlights.contains(expectedHighlightedToken.offset)) {
-            const auto [a2, b2, c2, d2, e2, f2] = highlights[expectedHighlightedToken.offset];
+        if (highlights.contains(expectedHighlightedToken.loc.offset)) {
+            const auto& actual = highlights[expectedHighlightedToken.loc.offset];
 
-            qDebug() << "Actual offset" << a2 << "Expected offset" << a1;
-            qDebug() << "Actual length" << b2 << "Expected length" << b1;
-            qDebug() << "Actual startLine" << c2 << "Expected startLine" << c1;
-            qDebug() << "Actual startColumn" << d2 << "Expected startColumn" << d1;
-            qDebug() << "Actual tokenType" << e2 << "Expected tokenType" << e1;
-            qDebug() << "Actual tokenModifier" << f2 << "Expected tokenModifier" << f1;
+            qDebug() << "Actual offset" << actual.loc.offset << "Expected offset" << expected.loc.offset;
+            qDebug() << "Actual length" << actual.loc.length << "Expected length" << expected.loc.length;
+            qDebug() << "Actual startLine" << actual.loc.startLine << "Expected startLine" << expected.loc.startLine;
+            qDebug() << "Actual startColumn" << actual.loc.startColumn << "Expected startColumn" << expected.loc.startColumn;
+            qDebug() << "Actual tokenType" << static_cast<int>(actual.kind) << "Expected tokenType" << static_cast<int>(expected.kind);
+            qDebug() << "Actual tokenModifier" << static_cast<int>(actual.modifiers) << "Expected tokenModifier" << static_cast<int>(expected.modifiers);
         } else {
             qDebug() << "Expected token not found in highlights";
-            const auto distance = [](HighlightToken actual, HighlightToken expected) {
-                return std::abs(actual.offset - expected.offset);
+            const auto distance = [](const HighlightToken& actual, const HighlightToken& expected) {
+                return qAbs(actual.loc.offset - expected.loc.offset);
             };
             double minDistance = std::numeric_limits<double>::max();
             const HighlightToken *closest = nullptr;
@@ -825,13 +845,12 @@ void tst_qmlls_highlighting::highlights()
             }
 
             if (closest) {
-                const auto [a2, b2, c2, d2, e2, f2] = *closest;
-                qDebug() << "Closest token offset" << a2 << "Expected offset" << a1;
-                qDebug() << "Closest token length" << b2 << "Expected length" << b1;
-                qDebug() << "Closest token startLine" << c2 << "Expected startLine" << c1;
-                qDebug() << "Closest token startColumn" << d2 << "Expected startColumn" << d1;
-                qDebug() << "Closest token type" << e2 << "Expected type" << e1;
-                qDebug() << "Closest token modifier" << f2 << "Expected modifier" << f1;
+                qDebug() << "Closest token offset" << closest->loc.offset << "Expected offset" << expected.loc.offset;
+                qDebug() << "Closest token length" << closest->loc.length << "Expected length" << expected.loc.length;
+                qDebug() << "Closest token startLine" << closest->loc.startLine << "Expected startLine" << expected.loc.startLine;
+                qDebug() << "Closest token startColumn" << closest->loc.startColumn << "Expected startColumn" << expected.loc.startColumn;
+                qDebug() << "Closest token type" << static_cast<int>(closest->kind) << "Expected type" << static_cast<int>(expected.kind);
+                qDebug() << "Closest token modifier" << static_cast<int>(closest->modifiers) << "Expected modifier" << static_cast<int>(expected.modifiers);
             }
         }
     }
-- 
2.51.2

