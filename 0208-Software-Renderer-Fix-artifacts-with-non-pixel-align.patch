From d20e8eb034846d1404461c014f4c88e8c060dcd1 Mon Sep 17 00:00:00 2001
From: Andy Nichols <andy.nichols@qt.io>
Date: Tue, 21 Oct 2025 16:39:06 +0200
Subject: [PATCH 208/239] Software Renderer: Fix artifacts with non pixel
 aligned content
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

It was possible that we would request to flush more of the backing store
than what was actually painted, which could lead to artifacts. Now when
there is a difference caused by the pixel alighment conversions, we make
sure to mark items behind that content as dirty so that everything
necessary to render correctly is painted.

Fixes: QTBUG-133368
Pick-to: 6.8
Change-Id: I9766017eb610792ffa17b745c356b614e4e28752
Reviewed-by: Christian Str√∏mme <christian.stromme@qt.io>
(cherry picked from commit a7925b7ae34e91418d6509501f34076c170df2ad)
Reviewed-by: Qt Cherry-pick Bot <cherrypick_bot@qt-project.org>
---
 .../adaptations/software/qsgabstractsoftwarerenderer.cpp     | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/src/quick/scenegraph/adaptations/software/qsgabstractsoftwarerenderer.cpp b/src/quick/scenegraph/adaptations/software/qsgabstractsoftwarerenderer.cpp
index 4f420cf945..a38e40d7e3 100644
--- a/src/quick/scenegraph/adaptations/software/qsgabstractsoftwarerenderer.cpp
+++ b/src/quick/scenegraph/adaptations/software/qsgabstractsoftwarerenderer.cpp
@@ -157,6 +157,11 @@ QRegion QSGAbstractSoftwareRenderer::optimizeRenderList()
             // Get the dirty region's to pass to the next nodes
             if (node->isOpaque()) {
                 // if isOpaque, subtract node's dirty rect from m_dirtyRegion
+                // node->boundingRectMax() is the area that might have been changed
+                // node->boundingRectMin() is the area that will have been changed
+                // This adding and subtracting will make sure that the "maybe" area is
+                // also marked dirty for the next nodes to prevent artifacts
+                m_dirtyRegion += node->boundingRectMax();
                 m_dirtyRegion -= node->boundingRectMin();
             } else {
                 // if isAlpha, add node's dirty rect to m_dirtyRegion
-- 
2.51.2

