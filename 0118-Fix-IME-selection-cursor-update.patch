From 0a62e1e45273229b4c73cd3d543ccc02da23dc09 Mon Sep 17 00:00:00 2001
From: Jarkko Koivikko <jarkko.koivikko@code-q.fi>
Date: Fri, 26 Sep 2025 13:52:27 +0300
Subject: [PATCH 118/239] Fix IME selection cursor update

The fix for QTBUG-94253 caused a regression in IME selection handling,
where the selection would not move the cursor when a commit string was
present. Cursor movement in this scenario is expected - for example, in
the word re-selection feature of the Qt Virtual Keyboard. The user
clicks inside the pre-edit text, and the VKB reselects a new segment up
to the clicked position. This is implemented using an IME event with
the commit string of the current pre-edit and the selection start
attribute set to the clicked position.

This patch refines the condition so that the original behavior of the
selection start parameter is handled correctly when the IME event
contains a commit string, with the exception of cases where an input
mask is present in the text input. This preserves the input mask
behavior fix from QTBUG-94253 while restoring correct selection
handling.

Pick-to: 6.8 6.5
Fixes: QTBUG-140400
Task-number: QTBUG-94253
Change-Id: I73d8ae32a1132d52cac9f39509ab2cbe922fa3d0
Reviewed-by: Richard Moe Gustavsen <richard.gustavsen@qt.io>
Reviewed-by: Frederic Lefebvre <frederic.lefebvre@qt.io>
(cherry picked from commit 9324f445c0e94ef55906b84004962226a131968a)
Reviewed-by: Qt Cherry-pick Bot <cherrypick_bot@qt-project.org>
---
 src/quick/items/qquicktextinput.cpp           |  8 ++-
 .../qquicktextinput/tst_qquicktextinput.cpp   | 66 +++++++++++++++++++
 2 files changed, 71 insertions(+), 3 deletions(-)

diff --git a/src/quick/items/qquicktextinput.cpp b/src/quick/items/qquicktextinput.cpp
index 7de6bd15c9..721a069509 100644
--- a/src/quick/items/qquicktextinput.cpp
+++ b/src/quick/items/qquicktextinput.cpp
@@ -3632,9 +3632,11 @@ void QQuickTextInputPrivate::processInputMethodEvent(QInputMethodEvent *event)
         if (a.type == QInputMethodEvent::Selection) {
             // If we already called internalInsert(), the cursor position will
             // already be adjusted correctly. The attribute.start does
-            // not seem to take the mask into account, so it will reset cursor
-            // to an invalid position in such case.
-            if (!cursorPositionChanged)
+            // not seem to take the mask into account, so it will reset the cursor
+            // to an invalid position in such case. However, when the input mask
+            // is not active, we must apply the cursor position regardless of the
+            // commit string.
+            if (!cursorPositionChanged || !m_maskData)
                 m_cursor = qBound(0, a.start + a.length, m_text.size());
             if (a.length) {
                 m_selstart = qMax(0, qMin(a.start, m_text.size()));
diff --git a/tests/auto/quick/qquicktextinput/tst_qquicktextinput.cpp b/tests/auto/quick/qquicktextinput/tst_qquicktextinput.cpp
index bdcbbcd18a..81ec1c5c88 100644
--- a/tests/auto/quick/qquicktextinput/tst_qquicktextinput.cpp
+++ b/tests/auto/quick/qquicktextinput/tst_qquicktextinput.cpp
@@ -212,6 +212,9 @@ private slots:
     void touchscreenDoesNotSelect();
     void touchscreenSetsFocusAndMovesCursor();
 
+    void imeSelectionWithCommitMovesCursor_NoMask();
+    void imeSelectionWithCommitDoesNotOverride_WithMask();
+
 private:
     void simulateKeys(QWindow *window, const QList<Key> &keys);
 #if QT_CONFIG(shortcut)
@@ -7260,6 +7263,69 @@ void tst_qquicktextinput::touchscreenSetsFocusAndMovesCursor()
     QVERIFY(top->selectedText().isEmpty());
 }
 
+void tst_qquicktextinput::imeSelectionWithCommitMovesCursor_NoMask()
+{
+    // QTBUG-140400: Selection (len 0) must move cursor even when commit is present.
+    QString componentStr = "import QtQuick 2.0\nTextInput { focus: true; text: \"abcdef\" }";
+    QQmlComponent comp(&engine);
+    comp.setData(componentStr.toLatin1(), QUrl());
+    QQuickTextInput *ti = qobject_cast<QQuickTextInput*>(comp.create());
+    QVERIFY(ti);
+
+    QQuickWindow win;
+    ti->setParentItem(win.contentItem());
+    win.show();
+    QVERIFY(QTest::qWaitForWindowActive(&win));
+    QVERIFY_ACTIVE_FOCUS(ti);
+
+    ti->setCursorPosition(3);
+    QCOMPARE(ti->cursorPosition(), 3);
+
+    // Commit + Selection(start=4, length=0) in the same IME event.
+    {
+        QList<QInputMethodEvent::Attribute> attrs;
+        attrs << QInputMethodEvent::Attribute(QInputMethodEvent::Selection, 4, 0, QVariant());
+        QInputMethodEvent ev(QString(), attrs);
+        ev.setCommitString("HELLO");
+        QGuiApplication::sendEvent(ti, &ev);
+    }
+
+    // Commit happened at old cursor (-> abcHELLOdef), then Selection moved cursor to 4.
+    QCOMPARE(ti->text(), QStringLiteral("abcHELLOdef"));
+    QCOMPARE(ti->selectionStart(), ti->selectionEnd());
+    QCOMPARE(ti->cursorPosition(), 4);
+}
+
+void tst_qquicktextinput::imeSelectionWithCommitDoesNotOverride_WithMask()
+{
+    // Preserve QTBUG-94253 behavior: with input mask, Selection must not override
+    // cursor set by internalInsert() when a commit is present.
+    QString componentStr = "import QtQuick 2.0\nTextInput { focus: true; inputMask: \"AA.AA.AA\" }";
+    QQmlComponent comp(&engine);
+    comp.setData(componentStr.toLatin1(), QUrl());
+    QQuickTextInput *ti = qobject_cast<QQuickTextInput*>(comp.create());
+    QVERIFY(ti);
+
+    QQuickWindow win;
+    ti->setParentItem(win.contentItem());
+    win.show();
+    QVERIFY(QTest::qWaitForWindowActive(&win));
+    QVERIFY_ACTIVE_FOCUS(ti);
+
+    // One IME event: commit + Selection(start: 4, length: 0). Selection start must NOT override the cursor.
+    {
+        QList<QInputMethodEvent::Attribute> attrs;
+        attrs << QInputMethodEvent::Attribute(QInputMethodEvent::Selection, 4, 0, QVariant());
+        QInputMethodEvent ev(QString(), attrs);
+        ev.setCommitString("HELLO");
+        QGuiApplication::sendEvent(ti, &ev);
+    }
+
+    // Matches existing mask expectations (cursor at the end after commit string)
+    QCOMPARE(ti->text(), QStringLiteral("HE.LL.O"));
+    QCOMPARE(ti->cursorPosition(), ti->text().size());
+}
+
 QTEST_MAIN(tst_qquicktextinput)
 
 #include "tst_qquicktextinput.moc"
-- 
2.51.2

